<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro</title>
    <link rel="stylesheet" href="index.html">
    <link rel="stylesheet" href="css/alterar.css">
    <!-- <link rel="stylesheet" href="css/header.css"> -->
    <script src="js/script.js"></script>
    <script src="js/cadastro.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
</head>

<body>

    <main>
        <div class="fundo_cadastro"></div>

        <!-- <h1 class="index texto_cadastro">Bem-Vindo à <br>
            NETMED</h1> -->

        <div id="div_mensagem" class="index"></div>
        <div class="main_cad index">

            <div class="titulo_cad">
                <div class="titulos_cad">
                    <span>INFORMAÇÕES</span>
                    <span>FUNÇÃO</span>
                    <span>FIM</span>
                </div>
                <div class="bar">
                    <input class="bar-input" type="radio" name="input" id="input_0" disabled />
                    <div class="bar-view">
                        <label class="bar-button" for="input_0" d></label>
                    </div>
                    <input class="bar-input" type="radio" name="input" id="input_1" disabled />
                    <div class="bar-view">
                        <label class="bar-button" for="input_1"></label>
                    </div>
                    <input class="bar-input" type="radio" name="input" id="input_2" disabled />
                    <div class="bar-view">
                        <label class="bar-button" for="input_2"></label>
                    </div>
                </div>
            </div>
            <div class="main_cad2 index" id="divCad">

                <div class="div_cadastro index">

                    <div class="inpts_cad_div">
                        <p class="white">Nome*</p>
                        <input type="text" class="inpts_cad" id="inpt_nome_alt">
                    </div>
                    <!-- <div id="cnpj_alt">
                            <p class="white">CPF*</p>
                            <input type="number" class="inpts_cad" id="inpt_cnpj_alt">
                        </div> -->

                    <div class="inpts_cad_div">
                        <p class="white">Email*</p>
                        <input type="email" class="inpts_cad" id="inpt_email_alt">
                    </div>

                    <div class="inpts_cad_div">
                        <p class="white">Senha*</p>
                        <input type="password" class="inpts_cad" id="inpt_senha_alt">
                    </div>

                    <div class="inpts_cad_div">
                        <p class="white">Confirmar Senha*</p>
                        <input type="password" class="inpts_cad" id="inpt_confSenha_alt">
                    </div>
                    <div class="inpts_cad_div">
                        <p class="white">Função*</p>
                        <select name="" id="inpt_funcao_cad" class="select_cadastro2">
                            <option value="nada">Escolha um gerente</option>
                            <option value="gerente">N3 - Gerente</option>
                            <option value="tecnico">N2 - Técnico</option>
                            <option value="atendente">N1 - Atendente</option>
                        </select>
                    </div>


                    <div class="inpts_cad_div btn_link_cad">
                        <button class="btn_cad_cont" id="btn_alterar_alt" onclick="alterar()">Alterar</button>
                        <button class="btn_cad_cont" id="btn_cancelar_alt">Cancelar</button>
                        <!-- <p class="white"><a href="login.html" >Já tem conta? Clique aqui para logar!</a></p> -->
                    </div>

                </div>


            </div>

            <div class="main_cad2 index" id="divCad2" style="display: none;">

                <div class="div_cadastro div_cadastro2 index ">


                    <p></p>


                    <div class="inpts_cad_div">
                        <p class="white">Senha Tecnico</p>
                        <input type="password" class="inpts_cad" id="inpt_confSenhaTec_alt">
                    </div>


                    <div class="inpts_cad_div btn_link_cad">
                        <button class="btn_cad_cont" id="btn_continuar_cad" onclick="alterar2()">Continuar</button>
                        <!-- <p class="white"><a href="login.html" >Já tem conta? Clique aqui para logar!</a></p> -->
                    </div>

                </div>
            </div>

            <div class="main_cad2 index" id="divCad3" style="display: none;">

                <div class="div_cadastro div_cadastro3 index">

                    <p>USUÁRIO CADASTRADO!</p>

                    <i class="bi bi-check "></i>

                    <div class="inpts_cad_div btn_link_cad">
                        <button class="btn_cad_cont" id="btn_continuar_cad" onclick="window.location.href = 'telaUsuario.html'">Continuar</button>
                        <!-- <p class="white"><a href="login.html" >Já tem conta? Clique aqui para logar!</a></p> -->
                    </div>

                </div>
            </div>
        </div>


    </main>

    <footer>

    </footer>

</body>

</html>

<script>
    window.onload = document.getElementById("input_2").checked = true;
    window.onload = plotarUser();

    function plotarUser() {
        var user = JSON.parse(sessionStorage.USUARIO_MUDAR);

        // alert(user.nome)

        var nomeVar = document.getElementById('inpt_nome_alt').value = user.nome;
        var emailVar = document.getElementById('inpt_email_alt').value = user.email;
        var senhaVar = document.getElementById('inpt_senha_alt').value = user.senha;
        var confirmacaoSenhaVar = document.getElementById('inpt_confSenha_alt');
        // var funcao = document.getElementById('inpt_funcao_cad').value = user.tipoUsuario;


        // nomeVar.value = user.nome;
    }


    function alterar() {
        // alert("asdlkmas")
        var sla = document.getElementById("input_1")
        // var cpf = document.getElementById('inpt_cnpj_alt').value;
        div_mensagem.innerHTML = "";
        var nomeVar = document.getElementById('inpt_nome_alt').value;
        var emailVar = document.getElementById('inpt_email_alt').value;
        var senhaVar = document.getElementById('inpt_senha_alt').value;
        var confirmacaoSenhaVar = document.getElementById('inpt_confSenha_alt').value;
        var funcao = document.getElementById('inpt_funcao_cad').value;
        var validacao = 0;

        // div_mensagem.innerHTML = "";
        // var nomeVar = document.getElementById('inpt_nome_cad').value;
        // var cpf = document.getElementById('inpt_cpf_cad').value;
        // var emailVar = document.getElementById('inpt_email_cad').value;
        // var senhaVar = document.getElementById('inpt_senha_cad').value;
        // var confirmacaoSenhaVar = document.getElementById('inpt_confSenha_cad').value;
        // var validacao = 0;

        if (funcao == "nada") {
            div_mensagem.innerHTML += `<p class="erro">Escolha uma função para o usuario<br>`;
            validacao = 1;
        }

        if (
            nomeVar.indexOf("#") >= 0 ||
            nomeVar.indexOf("@") >= 0 ||
            nomeVar.indexOf("!") >= 0 ||
            nomeVar.indexOf("%") >= 0 ||
            nomeVar.indexOf("*") >= 0 ||
            nomeVar.indexOf("$") >= 0 ||
            nomeVar.indexOf("&") >= 0
        ) {
            div_mensagem.innerHTML += `<p class="erro">-Não pode haver caracter especial no nome da empresa<br>`;
            validacao = 1;
        }

        //SENHA

        if (senhaVar.length < 8) {
            div_mensagem.innerHTML += `<p class="erro">-A senha deve possuir no mínimo 8 caracteres <br>`;
            validacao = 1;
        }

        if (senhaVar.indexOf(" ") >= 0) {
            div_mensagem.innerHTML += `<p class="erro">-Não pode conter espaços na senha <br>`;
            validacao = 1;
        }

        if (
            (
                senhaVar.indexOf("#") >= 0 ||
                senhaVar.indexOf("@") >= 0 ||
                senhaVar.indexOf("!") >= 0 ||
                senhaVar.indexOf("%") >= 0 ||
                senhaVar.indexOf("*") >= 0 ||
                senhaVar.indexOf("$") >= 0 ||
                senhaVar.indexOf("_") >= 0 ||
                senhaVar.indexOf("-") >= 0 ||
                senhaVar.indexOf("&") >= 0
            )
        ) {
            validacao != 1;
        } else {
            div_mensagem.innerHTML += `<p class="erro">-A senha deve possuir no mínimo 1 caracter especial <br>`;
        }

        if (senhaVar != confirmacaoSenhaVar) {
            div_mensagem.innerHTML += `<p class="erro">-Senhas incompatíveis`;
            validacao = 1;
        }

        //EMAIL

        if (!(emailVar.indexOf("@") >= 0)) {
            div_mensagem.innerHTML += `<p class="erro">-Deve conter @ no email<br>`;

            validacao = 1;
        }
        if (!(emailVar.indexOf(".com") >= 0)) {
            div_mensagem.innerHTML += `<p class="erro">-Deve conter .com no email <br>`;
            validacao = 1;

        }
        if (emailVar.indexOf(" ") >= 0) {
            div_mensagem.innerHTML += `<p class="erro">-Não pode conter espaços na email <br>`;
            validacao = 1;
        }
        //  alert(cpf)
        //  var validacaoCpf = TestaCPF(cpf)
        //  validacaoCpf = !validacaoCpf
        //  alert(validacaoCpf)
        //  if(validacaoCpf){
        //      div_mensagem.innerHTML += `<p class="erro">-O CPF está incorreto <br>`;
        //      validacao = 1;
        //  }
        if (validacao == 1) {
            // div_mensagem.style.display = "flex";
            
            }
            else {
                
                div_mensagem.style.display = "none";
                // alert('Parabens');
                animar('divCad', 'divCad2');
                        sla.checked = true;


        }

    }
    
    function alterar2() {
        var conf = document.getElementById("inpt_confSenhaTec_alt").value
        var sla2 = document.getElementById("input_0")
        div_mensagem.innerHTML = "";
        var nomeVar = document.getElementById('inpt_nome_alt').value;
        var emailVar = document.getElementById('inpt_email_alt').value;
        var senhaVar = document.getElementById('inpt_senha_alt').value;
        var confirmacaoSenhaVar = document.getElementById('inpt_confSenha_alt').value;
        var funcao = document.getElementById('inpt_funcao_cad').value;

        // alert(conf + " " + sessionStorage.SENHA_USUARIO)

        if(conf == sessionStorage.SENHA_USUARIO){   

        fetch("/usuarios/atualizarUsuario", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                // crie um atributo que recebe o valor recuperado aqui
                // Agora vá para o arquivo routes/usuario.js
                nomeServer: nomeVar,
                funcaoServer: funcao,
                emailServer: emailVar,
                idMudarServer: sessionStorage.IDUSUARIO_MUDAR,
                senhaServer: senhaVar
            }),

        }).then(function (resposta) {
            if (resposta.ok) {

                // sessionStorage.ID_USUARIO = usuario.insertId;
                sla2.checked = true;
                animar('divCad2', 'divCad3');
            } else {
                alert('Update não realizado')
                throw "Houve um erro ao tentar realizar o update"
            }
        })
            .catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
                alert('Update não realizado')
            })
        }
        else{
            alert("senha errada")
        }
    }
</script>